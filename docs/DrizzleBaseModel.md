# DrizzleBaseModel Documentation

The `DrizzleBaseModel` is a base class that provides a foundation for database operations using Drizzle ORM. It includes functionality for querying, filtering, searching, pagination, and ordering data from the database.

## Constructor

```ts
constructor(c)
```

Creates a new instance of the DrizzleBaseModel. Requires a context object containing the database environment variable (`c.env.DB`).

**Example:**
```ts
const model = new DrizzleBaseModel(context);
```

## Properties

| Property | Type | Description |
|----------|------|-------------|
| `pk` | any | Primary key field name, defaults to `"id"` |
| `path` | any | Path property, initially null |
| `schema` | any | Database schema reference |
| `db` | any | Drizzle ORM database instance |
| `logger` | any | Logger instance, initially null |
| `ready` | any | Ready state flag, defaults to `false` |
| `sqldb` | any | SQL database reference, initially null |
| `searchFields` | any[] | Array of searchable fields, defaults to empty array |

## Methods

### Basic Query Methods

#### `getAll()`
Returns all records from the table without any filtering.

**Returns:** Promise<Array> - All records from the table

**Example:**
```ts
const allUsers = await userModel.getAll();
```

#### `getRecords(orderBy)`
Returns all records from the table ordered by the specified field.

**Parameters:**
- `orderBy` - Order by clause generated by `addQueryOrder()` method

**Returns:** Promise<Array> - Records from the table in specified order

**Example:**
```ts
const orderBy = model.addQueryOrder({ name: 'asc' });
const records = await model.getRecords(orderBy);
```

#### `getRecords_withPage(orderBy, limit, offset)`
Returns records with pagination support.

**Parameters:**
- `orderBy` - Order by clause
- `limit` - Number of records to return
- `offset` - Starting position for the query

**Returns:** Promise<Array> - Paginated records

**Example:**
```ts
const records = await model.getRecords_withPage(orderBy, 10, 0); // Get first 10 records
```

### Filtering Methods

#### `getRecordsWithFilter(orderBy, condition)`
Returns records that match the specified filter condition.

**Parameters:**
- `orderBy` - Order by clause
- `condition` - Filter condition generated by `addQueryFilter()` method

**Returns:** Promise<Array> - Filtered records

**Example:**
```ts
const filterCondition = model.addQueryFilter({ status: 'active' });
const records = await model.getRecordsWithFilter(orderBy, filterCondition);
```

#### `getRecordsWithFilter_withPage(orderBy, limit, offset, condition)`
Returns filtered records with pagination support.

**Parameters:**
- `orderBy` - Order by clause
- `limit` - Number of records to return
- `offset` - Starting position for the query
- `condition` - Filter condition

**Returns:** Promise<Array> - Filtered and paginated records

**Example:**
```ts
const records = await model.getRecordsWithFilter_withPage(orderBy, 10, 0, filterCondition);
```

### Search Methods

#### `getRecordsWithSearch(orderBy, searchType, searchField, searchQuery)`
Returns records that match the search query.

**Parameters:**
- `orderBy` - Order by clause
- `searchType` - Either `"single"` to search in a specific field or `"all"` to search in all string fields
- `searchField` - Field name to search in (required when `searchType` is `"single"`)
- `searchQuery` - Text to search for

**Returns:** Promise<Array> - Search results

**Example:**
```ts
// Search in all string fields
const records = await model.getRecordsWithSearch(orderBy, 'all', null, 'john');

// Search in specific field
const records = await model.getRecordsWithSearch(orderBy, 'single', 'name', 'john');
```

#### `getRecordsWithSearch_withPage(orderBy, limit, offset, searchType, searchField, searchQuery)`
Returns search results with pagination support.

**Parameters:**
- `orderBy` - Order by clause
- `limit` - Number of records to return
- `offset` - Starting position for the query
- `searchType` - Either `"single"` or `"all"`
- `searchField` - Field name to search in
- `searchQuery` - Text to search for

**Returns:** Promise<Array> - Paginated search results

**Example:**
```ts
const records = await model.getRecordsWithSearch_withPage(orderBy, 10, 0, 'all', null, 'john');
```

#### `getRecordsWithSearch_withFilter_withPage(orderBy, condition, limit, offset, searchType, searchField, searchQuery)`
Returns records that match both search and filter criteria with pagination.

**Parameters:**
- `orderBy` - Order by clause
- `condition` - Filter condition
- `limit` - Number of records to return
- `offset` - Starting position for the query
- `searchType` - Either `"single"` or `"all"`
- `searchField` - Field name to search in
- `searchQuery` - Text to search for

**Returns:** Promise<Array> - Filtered, searched and paginated records

**Example:**
```ts
const records = await model.getRecordsWithSearch_withFilter_withPage(
  orderBy, 
  filterCondition, 
  10, 
  0, 
  'all', 
  null, 
  'john'
);
```

#### `getRecordsWithSearch_with_filter(orderBy, condition, searchType, searchField, searchQuery)`
Returns records that match both search and filter criteria without pagination.

**Parameters:**
- `orderBy` - Order by clause
- `condition` - Filter condition
- `searchType` - Either `"single"` or `"all"`
- `searchField` - Field name to search in
- `searchQuery` - Text to search for

**Returns:** Promise<Array> - Filtered and searched records

**Example:**
```ts
const records = await model.getRecordsWithSearch_with_filter(
  orderBy, 
  filterCondition, 
  'all', 
  null, 
  'john'
);
```

### Record Retrieval

#### `getRow(pk)`
Returns a single record by primary key or filter.

**Parameters:**
- `pk` - Primary key value or filter object

**Returns:** Promise<Object> - Single record or null if not found

**Example:**
```ts
const user = await model.getRow(1); // Get record with ID 1
const user = await model.getRow({ email: 'john@example.com' }); // Get record by email
```

### Count Methods

#### `count(filter?, search?)`
Counts records with optional filter and search parameters.

**Parameters:**
- `filter?` - Optional filter object
- `search?` - Optional search object

**Returns:** Promise<number> - Count of matching records

**Example:**
```ts
const totalActiveUsers = await model.count({ status: 'active' });
```

#### `countAll()`
Counts all records in the table.

**Returns:** Promise<number> - Total record count

**Example:**
```ts
const totalUsers = await model.countAll();
```

### Utility Methods

#### `isValidOrder(order)`
Validates if the order parameter is valid.

**Parameters:**
- `order` - Order object to validate

**Returns:** boolean - True if valid order, false otherwise

**Example:**
```ts
const isValid = model.isValidOrder({ name: 'asc' });
```

#### `isValidFilter(filter)`
Validates if the filter parameter is valid.

**Parameters:**
- `filter` - Filter object to validate

**Returns:** boolean - True if valid filter, false otherwise

**Example:**
```ts
const isValid = model.isValidFilter({ status: 'active' });
```

#### `isValidSearch(search)`
Validates if the search parameter is valid.

**Parameters:**
- `search` - Search object to validate with properties: `{ query: string, type: 'single'|'all', field?: string }`

**Returns:** boolean - True if valid search, false otherwise

**Example:**
```ts
const isValid = model.isValidSearch({ 
  query: 'john', 
  type: 'all' 
});
```

#### `isValidPage(page)`
Validates if the page parameter is valid.

**Parameters:**
- `page` - Page number to validate

**Returns:** boolean - True if valid page, false otherwise

**Example:**
```ts
const isValid = model.isValidPage(1);
```

#### `addQueryOrder(order)`
Generates an order clause for Drizzle ORM.

**Parameters:**
- `order` - Order object with field and direction

**Returns:** Drizzle order clause

**Example:**
```ts
const orderBy = model.addQueryOrder({ name: 'asc' });
```

#### `addQueryFilter(filter)`
Generates a filter condition for Drizzle ORM.

**Parameters:**
- `filter` - Filter object

**Returns:** Drizzle condition clause

**Example:**
```ts
const condition = model.addQueryFilter({ status: 'active' });
```

#### `addQuerySearch(searchFields, searchQuery)`
Generates a search condition for multiple fields.

**Parameters:**
- `searchFields` - Array of field names to search in
- `searchQuery` - Text to search for

**Returns:** Drizzle condition clause

**Example:**
```ts
const searchCondition = model.addQuerySearch(['name', 'email'], 'john');
```

#### `getSearchFields()`
Returns an array of string-type fields that can be searched.

**Returns:** Array<string> - Array of searchable field names

**Example:**
```ts
const fields = model.getSearchFields(); // ['name', 'email', 'description']
```

### Advanced Methods

#### `getList(limit, page, order, filter, search)`
Retrieves paginated list with all possible combinations of filtering, searching, and ordering.

**Parameters:**
- `limit` - Number of records per page (default: 5)
- `page` - Page number (default: 1)
- `order` - Order object (default: { pk: 'asc' })
- `filter` - Filter object
- `search` - Search object

**Returns:** Promise<Object> - Contains records and metadata
```ts
{
  limit: number,
  totalPages: number,
  totalRecords: number,
  recordCount: number,
  records: Array
}
```

**Example:**
```ts
const result = await model.getList(10, 1, { name: 'asc' }, { status: 'active' }, {
  query: 'john',
  type: 'all'
});
```

#### `getState(limit, page, filter, search)`
Gets pagination state without returning records.

**Parameters:**
- `limit` - Number of records per page (default: 5)
- `_page` - Page number (default: 1)
- `filter` - Filter object
- `search` - Search object

**Returns:** Promise<Object> - Pagination metadata
```ts
{
  limit: number,
  totalPages: number,
  totalRecords: number,
  recordCount: number
}
```

**Example:**
```ts
const state = await model.getState(10, 1, { status: 'active' }, {
  query: 'john',
  type: 'all'
});
```

#### `getListParam(limit, page, order, filter, search)`
Parses and validates list parameters.

**Parameters:**
- `limit` - Limit, page, order, filter, and search parameters

**Returns:** Object - Parsed and validated parameters

**Example:**
```ts
const params = model.getListParam(10, 1, { name: 'asc' }, { status: 'active' }, null);
```

## Usage Example

```ts
// Define a concrete model class extending DrizzleBaseModel
class UserModel extends DrizzleBaseModel {
  constructor(c) {
    super(c);
    this.schema = schema.users; // assuming 'users' table in schema
  }
}

// Usage
const user = new UserModel(context);

// Get paginated list with filtering and searching
const result = await user.getList(
  10, // limit
  1,  // page
  { name: 'asc' }, // order
  { status: 'active' }, // filter
  { query: 'john', type: 'all' } // search
);

console.log(result.records); // Array of users
console.log(result.totalPages); // Total number of pages
```

## Error Handling

The base model handles various error conditions:
- Invalid filters will be ignored
- Invalid search queries will be rejected
- Non-existent fields in filters/search will generate warnings
- Missing database connections will throw errors during query execution

This model serves as a foundation for creating specific models that handle particular database tables while providing consistent functionality for common database operations.